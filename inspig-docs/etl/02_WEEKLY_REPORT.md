# 주간 리포트 (Weekly Report)

DAY_GB: `WEEK`

## 1. 개요

주간 리포트는 매주 월요일 새벽 2시에 실행되어 지난주(월~일)의 농장 생산 데이터를 집계합니다.

### 1.1 실행 주기
- **스케줄**: 매주 월요일 02:00
- **대상 기간**: 지난주 월요일 ~ 일요일
- **대상 농장**: TS_INS_SERVICE 조건 충족 농장 (상세: 2장 참조)

### 1.2 날짜 계산 예시 (2025-12-22 월요일 실행 시)
```
지난주 (리포트 대상): 2025-12-15(월) ~ 2025-12-21(일)
금주 (예정 작업):      2025-12-22(월) ~ 2025-12-28(일)
```


## 2. 대상 농가 추출 프로세스

### 2.1 추출 조건 (TS_INS_SERVICE)

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          대상 농가 추출 프로세스                                   │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                      TS_INS_SERVICE 테이블 조건                            │ │
│  ├───────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                           │ │
│  │  1. INSPIG_YN = 'Y'         → 인사이트피그 서비스 사용 여부                  │ │
│  │  2. USE_YN = 'Y'            → 서비스 레코드 활성화 여부                      │ │
│  │                                                                           │ │
│  │  3. 서비스 기간 체크:                                                       │ │
│  │     ┌─────────────────────────────────────────────────────────────────┐   │ │
│  │     │  INSPIG_FROM_DT  <=  SYSDATE  <=  유효종료일                     │   │ │
│  │     │                                                                 │   │ │
│  │     │  유효종료일 = LEAST(INSPIG_TO_DT, INSPIG_STOP_DT)               │   │ │
│  │     │                                                                 │   │ │
│  │     │  ※ NULL 처리:                                                   │   │ │
│  │     │     - INSPIG_FROM_DT NULL → ❌ 제외 (시작일 필수)                │   │ │
│  │     │     - INSPIG_TO_DT NULL   → ❌ 제외 (종료일 필수)                │   │ │
│  │     │     - INSPIG_STOP_DT NULL → '99991231' (중지 안됨)               │   │ │
│  │     └─────────────────────────────────────────────────────────────────┘   │ │
│  │                                                                           │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────────┐ │
│  │                      TA_FARM 테이블 조건 (JOIN)                            │ │
│  ├───────────────────────────────────────────────────────────────────────────┤ │
│  │  USE_YN = 'Y'               → 농장 사용 여부                               │ │
│  └───────────────────────────────────────────────────────────────────────────┘ │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 조건별 상세 설명

| 조건 | 컬럼 | 설명 |
|------|------|------|
| 서비스 사용 | `INSPIG_YN = 'Y'` | 인사이트피그 서비스 신청 여부 |
| 레코드 활성 | `USE_YN = 'Y'` | 서비스 레코드 활성화 상태 |
| 시작일 필수 | `INSPIG_FROM_DT IS NOT NULL` | 시작일 없으면 제외 |
| 종료일 필수 | `INSPIG_TO_DT IS NOT NULL` | 종료일 없으면 제외 |
| 시작일 체크 | `SYSDATE >= INSPIG_FROM_DT` | 서비스 시작일 이후여야 함 |
| 종료일 체크 | `SYSDATE <= INSPIG_TO_DT` | 서비스 종료일 이전이어야 함 |
| 중지일 체크 | `SYSDATE <= INSPIG_STOP_DT` | 서비스 중지일 이전이어야 함 (NULL이면 중지 안됨) |

### 2.3 실행 모드별 농가 추출

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          실행 모드별 농가 추출 흐름                                │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [1] 정규 스케줄 실행 (Cron: 매주 월요일 02:00)                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  python run_etl.py weekly                                               │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  ┌──────────────────────────────────────────────┐                       │    │
│  │  │ _get_target_farms(farm_list=None)            │                       │    │
│  │  │                                              │                       │    │
│  │  │ → TS_INS_SERVICE 전체 조건 체크               │                       │    │
│  │  │ → 조건 충족하는 모든 농장 반환                 │                       │    │
│  │  └──────────────────────────────────────────────┘                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  [2] 테스트 모드 실행 (--test)                                                   │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  python run_etl.py weekly --test                                        │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  ┌──────────────────────────────────────────────┐                       │    │
│  │  │ _get_target_farms(farm_list=TEST_FARM_LIST)  │                       │    │
│  │  │                                              │                       │    │
│  │  │ → TEST_FARM_LIST = '1387,2807,4448,1456,...' │                       │    │
│  │  │ → TS_INS_SERVICE 조건 체크 + FARM_NO 필터     │                       │    │
│  │  │ → 테스트 농장 중 조건 충족하는 농장만 반환     │                       │    │
│  │  └──────────────────────────────────────────────┘                       │    │
│  │                                                                         │    │
│  │  ※ test_mode=True, init_delete=True → 기존 데이터 전체 삭제 후 생성      │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  [3] 날짜 범위 지정 실행 (--date-from, --date-to)                                │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  python run_etl.py --date-from 2025-11-10 --date-to 2025-12-22          │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  ┌──────────────────────────────────────────────┐                       │    │
│  │  │ 날짜 범위 내 각 주(월요일)마다 반복 실행:      │                       │    │
│  │  │   2025-11-10 → 45주차 생성                   │                       │    │
│  │  │   2025-11-17 → 46주차 생성                   │                       │    │
│  │  │   ...                                        │                       │    │
│  │  │   2025-12-22 → 51주차 생성                   │                       │    │
│  │  │                                              │                       │    │
│  │  │ ※ 각 주마다 _get_target_farms() 호출         │                       │    │
│  │  │ ※ 농장 조건은 ETL 실행일(SYSDATE) 기준 체크   │                       │    │
│  │  └──────────────────────────────────────────────┘                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
│  [4] 단일 농장 수동 실행 (--manual --farm-no)                                    │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  python run_etl.py --manual --farm-no 2807                              │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  ┌──────────────────────────────────────────────┐                       │    │
│  │  │ run_single_farm(farm_no=2807)                │                       │    │
│  │  │                                              │                       │    │
│  │  │ → TA_FARM에서 직접 조회 (TS_INS_SERVICE 무시) │                       │    │
│  │  │ → 서비스 가입 여부와 무관하게 강제 생성        │                       │    │
│  │  └──────────────────────────────────────────────┘                       │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 서비스 기간 예시

```
시나리오 1: 정상 서비스 기간 내
┌──────────────────────────────────────────────────────────────────┐
│ INSPIG_FROM_DT = 20250101                                        │
│ INSPIG_TO_DT   = 20251231                                        │
│ INSPIG_STOP_DT = NULL (99991231)                                 │
│                                                                  │
│ 실행일 2025-06-15:                                                │
│   20250101 <= 20250615 <= 20251231  → ✅ 대상                    │
└──────────────────────────────────────────────────────────────────┘

시나리오 2: 서비스 시작 전
┌──────────────────────────────────────────────────────────────────┐
│ INSPIG_FROM_DT = 20250701                                        │
│ INSPIG_TO_DT   = 20251231                                        │
│                                                                  │
│ 실행일 2025-06-15:                                                │
│   20250615 < 20250701  → ❌ 제외 (시작일 이전)                    │
└──────────────────────────────────────────────────────────────────┘

시나리오 3: 서비스 종료 후
┌──────────────────────────────────────────────────────────────────┐
│ INSPIG_FROM_DT = 20240101                                        │
│ INSPIG_TO_DT   = 20241231                                        │
│                                                                  │
│ 실행일 2025-06-15:                                                │
│   20250615 > 20241231  → ❌ 제외 (종료일 이후)                    │
└──────────────────────────────────────────────────────────────────┘

시나리오 4: 서비스 중지 (STOP_DT < TO_DT)
┌──────────────────────────────────────────────────────────────────┐
│ INSPIG_FROM_DT = 20250101                                        │
│ INSPIG_TO_DT   = 20251231                                        │
│ INSPIG_STOP_DT = 20250601  ← 6월 1일에 중지됨                     │
│                                                                  │
│ 실행일 2025-06-15:                                                │
│   LEAST(20251231, 20250601) = 20250601                           │
│   20250615 > 20250601  → ❌ 제외 (중지일 이후)                    │
└──────────────────────────────────────────────────────────────────┘

시나리오 5: 시작일/종료일 NULL (미가입)
┌──────────────────────────────────────────────────────────────────┐
│ INSPIG_FROM_DT = NULL                                            │
│ INSPIG_TO_DT   = NULL                                            │
│                                                                  │
│ → ❌ 제외 (시작일/종료일 필수)                                     │
│                                                                  │
│ ※ INSPIG_YN = 'Y'라도 FROM_DT, TO_DT가 없으면 서비스 미가입 상태   │
└──────────────────────────────────────────────────────────────────┘
```


## 3. 실행 흐름

```
run_etl.py weekly
       │
       ▼
WeeklyReportOrchestrator.run()
       │
       ├──▶ Step 1: 외부 데이터 수집 (병렬 처리)
       │         ├── ProductivityCollector (생산성 API)
       │         │     └── get_service_farm_nos() ← 공통 농장 조회
       │         │
       │         └── WeatherCollector (기상청 API)
       │
       └──▶ Step 2: 주간 리포트 생성
              │
              ├── 전국 탕박 평균 단가 계산
              ├── TS_INS_MASTER 생성(주차정보)
              ├── get_service_farms() ← 공통 농장 조회
              │
              └── 농장별 병렬 처리 (ThreadPoolExecutor)
                     │
                     └──▶ FarmProcessor.process()
                            │
                            ├── FarmDataLoader.load() (데이터 1회 로드)
                            │
                            └── 프로세서 순차 실행 (10개)
                                 ├── 1. ConfigProcessor    (설정값)
                                 ├── 2. AlertProcessor     (관리대상)
                                 ├── 3. ModonProcessor     (모돈현황)
                                 ├── 4. MatingProcessor    (교배)
                                 ├── 5. FarrowingProcessor (분만)
                                 ├── 6. WeaningProcessor   (이유)
                                 ├── 7. AccidentProcessor  (임신사고)
                                 ├── 8. CullingProcessor   (도태폐사)
                                 ├── 9. ShipmentProcessor  (출하)
                                 └── 10. ScheduleProcessor (금주예정)

※ 농장 목록 조회 SQL은 src/common/farm_service.py에서 중앙 관리
```


## 3. 프로세서 상세

### 3.1 프로세서 목록

| # | 프로세서 | GUBUN | 설명 | Oracle 원본 |
|---|----------|-------|------|-------------|
| 1 | ConfigProcessor | CONFIG | 농장 설정값 | SP_INS_WEEK_CONFIG |
| 2 | AlertProcessor | MANAGE | 관리대상 모돈 | SP_INS_WEEK_MANAGE_SOW |
| 3 | ModonProcessor | MODON | 모돈현황 통계 | SP_INS_WEEK_MODON |
| 4 | MatingProcessor | MATING | 교배 현황 | SP_INS_WEEK_MATING |
| 5 | FarrowingProcessor | BUN | 분만 현황 | SP_INS_WEEK_BUN |
| 6 | WeaningProcessor | EU | 이유 현황 | SP_INS_WEEK_EU |
| 7 | AccidentProcessor | SAGO | 임신사고 현황 | SP_INS_WEEK_SAGO |
| 8 | CullingProcessor | DOPE | 도태/폐사 현황 | SP_INS_WEEK_DOPE |
| 9 | ShipmentProcessor | SHIP | 출하 현황 | SP_INS_WEEK_SHIP |
| 10 | ScheduleProcessor | SCHEDULE | 금주 예정 작업 | SP_INS_WEEK_SCHEDULE |

### 3.2 TS_INS_WEEK_SUB 데이터 생성 현황 (1농장 1주차 기준)

| 프로세서       | GUBUN    | SUB_GUBUN        | 건수     | 비고                             |
|----------------|----------|------------------|----------|----------------------------------|
| config.py      | CONFIG   | -                | 1        | 농장 설정                        |
| alert.py       | ALERT    | -                | 4        | 관리대상 모돈 (지연기간별 집계)  |
| modon.py       | MODON    | -                | 10       | 산차별 (후보돈~8산+)             |
| mating.py      | GB       | STAT             | 1        | 교배 요약                        |
|                | GB       | CHART            | 1        | 재귀일별 차트                    |
|                | GB       | HINT             | 1        | 힌트                             |
| farrowing.py   | BM       | -                | 1        | 분만 통계                        |
|                | BM       | HINT             | 1        | 힌트                             |
| weaning.py     | EU       | -                | 1        | 이유 통계                        |
|                | EU       | HINT             | 1        | 힌트                             |
| accident.py    | SG       | STAT             | 2        | 원인별 사고                      |
|                | SG       | CHART            | 1        | 경과일별 차트                    |
| culling.py     | DOPE     | STAT             | 2        | 유형별 통계                      |
|                | DOPE     | LIST             | **가변** | 원인별 목록                      |
|                | DOPE     | CHART            | 1        | 상태별 차트                      |
| shipment.py    | SHIP     | ROW              | 13       | 출하 크로스탭                    |
|                | SHIP     | STAT             | 1        | 출하 통계                        |
|                | SHIP     | CHART            | 7        | 일별 차트                        |
|                | SHIP     | SCATTER          | 1        | 산점도 (JSON_DATA CLOB)          |
| schedule.py    | SCHEDULE | -                | 1        | 요약                             |
|                | SCHEDULE | CAL              | 4~6      | 캘린더 그리드                    |
|                | SCHEDULE | GB/BM/EU/VACCINE | **가변** | 팝업 상세 (TB_PLAN_MODON 기반)   |
|                | SCHEDULE | IMSIN            | **가변** | 임신감정 상세                    |
|                | SCHEDULE | HELP             | 1        | 도움말                           |
|                | SCHEDULE | METHOD           | 1        | 산정방식                         |

**참고사항:**
- HINT 정보는 GB/BM/EU STAT ROW의 HINT1 컬럼에도 저장됨
- SCATTER는 JSON_DATA CLOB 컬럼에 `[{"x":도체중,"y":등지방,"cnt":두수}, ...]` 형식으로 저장
- SCHEDULE 팝업 상세는 산정방식이 modon(모돈작업설정)일 때만 생성


## 4. 기술 구현

### 4.1 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                      FarmProcessor                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  1. FarmDataLoader.load()                                       │
│     └── Oracle DB에서 모든 원시 데이터 1회 로드                   │
│         ├── 모돈 정보 (TA_MODON)                                 │
│         ├── 작업 이력 (TB_WORK_MODON)                            │
│         ├── 분만 정보 (TB_BUN_MODON)                             │
│         ├── 폐사/사고 정보 (TB_DEAD_MODON)                       │
│         └── 기타 참조 테이블                                     │
│                                                                 │
│  2. 프로세서 순차 실행                                           │
│     └── 각 프로세서는 로드된 데이터를 Python으로 가공             │
│         ├── filter_by_period()                                  │
│         ├── group_by()                                          │
│         ├── sum_field(), count()                                │
│         └── pivot_data()                                        │
│                                                                 │
│  3. 결과 저장                                                    │
│     └── TS_INS_WEEK, TS_INS_WEEK_SUB INSERT/UPDATE              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 4.2 병렬 처리 구조

```
Level 1: 농장별 병렬 (ThreadPoolExecutor)
         max_farm_workers = 4
         │
         ├── Farm A ──┬── Processor 1~10
         │
         ├── Farm B ──┬── Processor 1~10
         │
         └── Farm C ──┬── ...
```

### 4.3 BaseProcessor 주요 메서드

#### 데이터 조회/저장

| 메서드 | 설명 |
|--------|------|
| `fetch_all(sql, params)` | SELECT 결과를 튜플 리스트로 반환 |
| `fetch_dict(sql, params)` | SELECT 결과를 딕셔너리 리스트로 반환 |
| `execute(sql, params)` | INSERT/UPDATE/DELETE 실행 |
| `save_sub(sub_type, data)` | TS_INS_WEEK_SUB 저장 |
| `update_week(updates)` | TS_INS_WEEK 업데이트 |

#### Python 데이터 가공

| 메서드 | 설명 |
|--------|------|
| `filter_by_period(data, date_field, dt_from, dt_to)` | 기간 필터링 |
| `filter_by_code(data, code_field, code_value)` | 코드값 필터링 |
| `group_by(data, key_field)` | 단일 필드 그룹핑 |
| `count(data)` / `sum_field(data, field)` | 집계 |
| `pivot_data(data, row_key, col_key, value_field, agg)` | 피벗 변환 |


## 5. 프로세서별 특이사항

### 5.1 WeaningProcessor (이유)

- **DAERI_YN 분기 처리**: 대리모돈 자돈 증감 계산 시 ETL 수행일(SYSDATE)이 아닌 dt_to(지난주 일요일) 기준 사용

### 5.2 ScheduleProcessor (금주 예정)

#### 5.2.1 산정방식 분기 처리 (TS_INS_CONF)

금주 작업예정은 **농장기본값** 또는 **모돈작업설정** 두 가지 방식으로 산정할 수 있습니다.
농장별로 TS_INS_CONF 테이블에 설정된 값에 따라 분기 처리됩니다.

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    금주 작업예정 산정방식 분기 처리 흐름                            │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [1] TS_INS_CONF 설정 조회                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ WEEK_TW_GY: {"method":"farm"}           ← 교배예정                       │    │
│  │ WEEK_TW_BM: {"method":"modon","tasks":[1,2]}  ← 분만예정                 │    │
│  │ WEEK_TW_IM: {"method":"farm"}           ← 임신감정                       │    │
│  │ WEEK_TW_EU: {"method":"modon","tasks":[3]}    ← 이유예정                 │    │
│  │ WEEK_TW_VC: {"method":"modon","tasks":[]}     ← 백신예정                 │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                              │                                                  │
│                              ▼                                                  │
│  [2] 예정 유형별 분기 처리                                                       │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │                                                                         │    │
│  │   ┌──────────────┐                    ┌──────────────┐                  │    │
│  │   │ method=farm  │                    │ method=modon │                  │    │
│  │   │ (농장기본값)  │                    │ (모돈작업설정) │                  │    │
│  │   └──────┬───────┘                    └──────┬───────┘                  │    │
│  │          │                                   │                          │    │
│  │          ▼                                   ▼                          │    │
│  │   TC_FARM_CONFIG에서                  FN_MD_SCHEDULE_BSE_2020            │    │
│  │   기간값 조회 후 계산                  Oracle Function 호출               │    │
│  │                                                                         │    │
│  │   ┌─────────────────────────┐       ┌─────────────────────────┐        │    │
│  │   │ 901001: 평균임신기간     │       │ TB_PLAN_MODON 기준       │        │    │
│  │   │ 901002: 평균포유기간     │       │ tasks=[1,2,3] 필터       │        │    │
│  │   │ 901003: 평균재귀일       │       │                         │        │    │
│  │   │ 901007: 초교배일령       │       │ seq_filter='1,2,3'       │        │    │
│  │   └─────────────────────────┘       └─────────────────────────┘        │    │
│  │                                                                         │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                              │                                                  │
│                              ▼                                                  │
│  [3] 데이터 저장 (TS_INS_WEEK_SUB)                                               │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │ SUB_GUBUN='-'     : 요약 카운트                                          │    │
│  │ SUB_GUBUN='CAL'   : 캘린더 데이터 (요일별 카운트)                          │    │
│  │ SUB_GUBUN='GB'    : 교배예정 팝업 (모돈작업설정일 때만)                     │    │
│  │ SUB_GUBUN='BM'    : 분만예정 팝업 (모돈작업설정일 때만)                     │    │
│  │ SUB_GUBUN='EU'    : 이유예정 팝업 (모돈작업설정일 때만)                     │    │
│  │ SUB_GUBUN='IMSIN' : 임신감정 팝업 (모돈작업설정일 때만)                     │    │
│  │ SUB_GUBUN='VACCINE': 백신예정 팝업 (항상 모돈작업설정)                      │    │
│  │ SUB_GUBUN='METHOD': 산정방식 정보 (farm/modon)                            │    │
│  │ SUB_GUBUN='HELP'  : 도움말 정보                                           │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

#### 5.2.2 예정 유형별 산정 기준

| 예정 유형 | 농장기본값 (method=farm) | 모돈작업설정 (method=modon) |
|----------|------------------------|---------------------------|
| **교배예정** | 이유일 + 평균재귀일(901003) / 생년월일 + 초교배일령(901007) | FN_MD_SCHEDULE_BSE_2020('150005') |
| **분만예정** | 교배일 + 평균임신기간(901001) | FN_MD_SCHEDULE_BSE_2020('150002') |
| **임신감정** | 교배일 + 21일(3주) / 28일(4주) 고정 | FN_MD_SCHEDULE_BSE_2020('150001') |
| **이유예정** | 분만일 + 평균포유기간(901002) | FN_MD_SCHEDULE_BSE_2020('150003') |
| **백신예정** | - (항상 modon) | FN_MD_SCHEDULE_BSE_2020('150004') |

#### 5.2.3 SUB_GUBUN='METHOD' 저장 구조

웹에서 산정방식에 따른 화면 분기 처리를 위해 각 예정별 method 정보를 저장합니다.

| 컬럼 | 내용 |
|------|------|
| STR_1 | 교배예정 method (farm/modon) |
| STR_2 | 분만예정 method (farm/modon) |
| STR_3 | 임신감정 method (farm/modon) |
| STR_4 | 이유예정 method (farm/modon) |
| STR_5 | 백신예정 method (farm/modon) |

#### 5.2.4 캘린더 데이터 분기 (SUB_GUBUN='CAL')

임신감정은 산정방식에 따라 캘린더 표시가 달라집니다:

| 산정방식 | 캘린더 CODE_1 | 설명 |
|----------|--------------|------|
| 농장기본값 | IMSIN_3W, IMSIN_4W | 3주(21일), 4주(28일) 별도 표시 |
| 모돈작업설정 | IMSIN | 통합 표시 (TB_PLAN_MODON 기준) |

#### 5.2.5 팝업 상세 분기 (SUB_GUBUN='GB/BM/EU/IMSIN')

| 산정방식 | 팝업 상세 | 비고 |
|----------|----------|------|
| farm (농장기본값) | 생략 | 팝업 클릭 시 "농장기본값 기준" 메시지 표시 |
| modon (모돈작업설정) | INSERT | 작업명별 그룹화 |

#### 5.2.6 HELP 정보 (SUB_GUBUN='HELP')

HELP 데이터는 웹에서 도움말 버튼 클릭 시 표시됩니다.

| 컬럼 | 내용 | 예시 |
|------|------|------|
| STR_1 | 교배예정 산출기준 | `'농장기본값'` 또는 `'분만대기(115일),분만임박(113일)'` |
| STR_2 | 분만예정 산출기준 | 동일 |
| STR_3 | 이유예정 산출기준 | 동일 |
| STR_4 | 백신예정 산출기준 | 동일 |
| STR_5 | 출하예정 계산 정보 | `'* 육성율: 92% ...'` |
| STR_6 | 임신감정 산출기준 | `'(농장기본값) 교배후 3주(21일), 4주(28일) 대상모돈'` |

### 5.3 CullingProcessor (도태/폐사)

- **원인별 피벗 구조**: DOPE_GUBUN_CD별 CNT를 피벗하여 CNT_1(050011) ~ CNT_10(050020)에 저장

### 5.4 Oracle Function 연동

- **FN_MD_SCHEDULE_BSE_2020**: 모돈작업설정(method=modon) 시 예정 모돈 목록 조회에 사용
- 참조: `schedule.py`


## 6. 에러 처리

- **농장별 에러 격리**: 특정 농장 처리 실패 시 해당 농장만 ERROR 상태로 기록
- **에러 로그 테이블**: TS_INS_JOB_LOG에 에러 정보 저장


## 7. API 응답 필드

### 7.1 ETL 실행 응답 (POST /api/run-farm)

```json
{
    "status": "success",
    "farmNo": 2807,
    "dayGb": "WEEK",
    "masterSeq": 123,
    "shareToken": "abc123...",
    "year": 2025,
    "weekNo": 52,
    "insDate": "20251229",
    "dtFrom": "20251222",
    "dtTo": "20251228"
}
```

### 7.2 masterSeq 필드 설명

| 필드 | 설명 |
|------|------|
| `masterSeq` | TS_INS_MASTER.SEQ (PK) |

**masterSeq가 필요한 이유:**
- 동일 농장/년도/주차에 리포트가 재생성될 수 있음
- 예: 데이터 오류로 TS_INS_* 테이블 삭제 후 재생성
- 정확한 리포트 식별을 위해 PK(masterSeq) 사용

**masterSeq 사용처:**
- SMS/알림톡 발송 시 필수 파라미터
- `selectInsWeeklyReportForManual(farmNo, reportYear, reportWeekNo, masterSeq)`
- masterSeq가 없으면 "마스터 시퀀스가 필요합니다." 에러 발생

### 7.3 pig3.1 연동 흐름

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           masterSeq 전달 흐름                                    │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  [1] ETL API 서버 (inspig-etl)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  POST /api/run-farm                                                     │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  RunFarmResponse {                                                      │    │
│  │      status: "success",                                                 │    │
│  │      masterSeq: 123,      ← TS_INS_MASTER.SEQ 반환                       │    │
│  │      shareToken: "abc...",                                              │    │
│  │      ...                                                                │    │
│  │  }                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                              │                                                  │
│                              ▼                                                  │
│  [2] pig3.1 서버 (InsEtlApiController)                                          │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  POST /officers/api/ins/getOrCreateWeeklyReport.json                    │    │
│  │         │                                                               │    │
│  │         ▼                                                               │    │
│  │  result.put("masterSeq", reportResult.get("masterSeq"));                │    │
│  │  result.put("shareToken", reportResult.get("shareToken"));              │    │
│  │  ...                                                                    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                              │                                                  │
│                              ▼                                                  │
│  [3] 프론트엔드 (JSP)                                                           │
│  ┌─────────────────────────────────────────────────────────────────────────┐    │
│  │  var masterSeq = result.masterSeq;                                      │    │
│  │  var shareToken = result.shareToken;                                    │    │
│  │                                                                         │    │
│  │  // SMS 발송 시 masterSeq 전달                                           │    │
│  │  sendSms({                                                              │    │
│  │      farmNo: farmNo,                                                    │    │
│  │      masterSeq: masterSeq,       ← 필수                                  │    │
│  │      reportYear: year,                                                  │    │
│  │      reportWeekNo: weekNo,                                              │    │
│  │      toTel: phoneNumber                                                 │    │
│  │  });                                                                    │    │
│  └─────────────────────────────────────────────────────────────────────────┘    │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```
